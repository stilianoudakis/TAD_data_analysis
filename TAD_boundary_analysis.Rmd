---
title: "TAD Boundary Analysis"
author: "Spiro Stilianoudakis"
date: "April 15, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries

```{r}
library(MultiAssayExperiment)
library(GenomicRanges)
library(IRanges)
library(caret)
library(data.table)
library(gbm)
library(pROC)
library(plyr)
library(dplyr)
```


# Reading in TAD data

```{r}

setwd("C:/Users/Spiro Stilianoudakis/Documents/TAD_data_analysis/data")

domains <- read.table("arrowhead_data.txt", header=T)
domains <- domains[,1:3]
head(domains)
dim(domains)
#9274   3

#Focusing just on chromosome 22
#chr22_domains <- domains[which(domains$Chromosome=="chr22"),]
#dim(chr22_domains)

```

# Creating TAD boundaries

## The TAD boundary start and end coordinates were row binded into one long vector. The vector was sorted and each coordinate was flanked on each side by 500 bases for a 1kb TAD boundary bin.

```{r}

# Creating a GRanges object out of the tads

colnames(domains)[2:3] <- c("coordinate", "coordinate")
coords <- rbind.data.frame(domains[,c(1,2)],domains[,c(1,3)])

#Separating the X chromosome from the rest of the numeric chromosomes
coordsX <- coords[which(coords$Chromosome=="chrX"),]
coordsnoX <- coords[-which(coords$Chromosome=="chrX"),]

#Sorting the numeric chromosome coordinates
coordsnoX <- coordsnoX[order(as.numeric(substr(coordsnoX$Chromosome,4,5)), coordsnoX$coordinate),]

#Sorting the X chromosome coordinates
coordsX <- coordsX[order(coordsX$coordinate),]

#Combining the two datasets into one which is sorted by chromosome and coordinate
allcoords <- rbind.data.frame(coordsnoX, coordsX)
dim(allcoords)
head(allcoords)


#remove duplicates for coordinates that are conjoined
allcoords <- allcoords[!duplicated(allcoords),]
dim(allcoords)
#17201     2

# flanking either side of the TAD boundary by 500 bases for a 1kb centerd boundary region
allcoords$Chromosome <- as.character(allcoords$Chromosome)
bounds <- GRanges(seqnames=allcoords$Chromosome, ranges=IRanges(start=allcoords$coordinate, width=1))
bounds <- resize(bounds, 1000, fix = "center")
bounds

#Creating 1kb bin from min-500 to max+500 for each chromosome
#A flanked TAD boundary will be represented in these bins
bins <- rep( list(GRangesList()), 23 )

for(i in 1:length(unique(allcoords$Chromosome))){
seqn <- unique(allcoords$Chromosome)[i]

midpt <- ((min(allcoords$coordinate[which(allcoords$Chromosome==unique(allcoords$Chromosome)[i])])-500) + 
            (max(allcoords$coordinate[which(allcoords$Chromosome==unique(allcoords$Chromosome)[i])])+500))/2

bins[[i]] <- GRanges(seqnames=seqn, 
                ranges=IRanges(start=seq(min(allcoords$coordinate[which(allcoords$Chromosome==unique(allcoords$Chromosome)[1])])-500, 
                                         max(allcoords$coordinate[which(allcoords$Chromosome==unique(allcoords$Chromosome)[1])])+500,
                                         1000),
                               width=1000))

}

binslist <- GRangesList(bins)
binslist <- unlist(binslist)

#Creating an indicator variable Y that denotes whether the tad boundary overlaps the genomic bin 

y <- countOverlaps(binslist, bounds)
length(y)
table(y)
prop.table(table(y))

```

# Reading in genomic feature data (subcompartments)

```{r}
subcompart <- read.table("GSE63525_GM12878_subcompartments.BED",header = F)
subcompart <- subcompart[,1:4]
names(subcompart) <- c("chr", "x1", "x2", "compartment")
dim(subcompart)
subcompart <- subcompart[-which(is.na(subcompart$compartment)),]
head(subcompart)
table(subcompart$compartment)
subcompart$compartment <- as.character(subcompart$compartment)

#combining compartments
subcompart$compartment[grep("A",subcompart$compartment)] <- "A"
subcompart$compartment[grep("B",subcompart$compartment)] <- "B"
table(subcompart$compartment)

#Creating GRanges object out of subcompartment data
subcompart$chr <- as.character(subcompart$chr)
subcompartgr <- GRanges(seqnames = subcompart$chr, 
                        ranges = IRanges(start=subcompart$x1,
                                         end=subcompart$x2))
mcols(subcompartgr)$compartment <- subcompart$compartment

#Finding where the 1kb bins overlap the subcompartments and labeling the overlap as A or B
subcompoverlap <- findOverlaps(binslist, subcompartgr, type="within")

compartment1 <- cbind.data.frame(queryhits=queryHits(subcompoverlap),compartment=mcols(subcompartgr[subjectHits(subcompoverlap)])[,1])
compartment2 <- cbind.data.frame(queryhits=setdiff(seq(1,5695536),queryHits(subcompoverlap)),compartment="N")
head(compartment1)
head(compartment2)
dim(compartment1)
dim(compartment2)
dim(compartment1)[1]+dim(compartment2)[1]

complabels <- rbind.data.frame(compartment1,compartment2)
complabels <- complabels[order(complabels$queryhits),]

#Adding the vector of responses y and the compartment vector to the binslist granges object as metadata
mcols(binslist)$y <- y
mcols(binslist)$compartment <- complabels[,2]

table(mcols(binslist)$compartment)
prop.table(table(mcols(binslist)$compartment))
table(mcols(binslist)$compartment[-which(seqnames(binslist)=="chrX")])
prop.table(table(mcols(binslist)$compartment[-which(seqnames(binslist)=="chrX")]))
table(mcols(binslist)$compartment[which(seqnames(binslist)=="chrX")])



```

# Creating a data frame to use for logistic regression

```{r}
logitdata <- data.frame(y = mcols(binslist)$y, x = mcols(binslist)$compartment)
logitdata$x <- as.factor(logitdata$x)

#removing rows where compartment is N
logitdata <- logitdata[-which(logitdata$x=="N"),]
dim(logitdata)

```

