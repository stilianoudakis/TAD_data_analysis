---
title: "TAD Boundary Analysis"
author: "Spiro Stilianoudakis"
date: "April 15, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries

```{r}
library(MultiAssayExperiment)
library(GenomicRanges)
library(IRanges)
library(caret)
library(data.table)
library(gbm)
library(pROC)
library(plyr)
library(dplyr)
```


# Reading in TAD data

```{r}

setwd("C:/Users/Spiro Stilianoudakis/Documents/TAD_data_analysis/data")

domains <- read.table("arrowhead_data.txt", header=T)
domains <- domains[,1:3]
head(domains)
dim(domains)
#9274   3

#Focusing just on chromosome 22
chr22_domains <- domains[which(domains$Chromosome=="chr22"),]
dim(chr22_domains)

```

# Creating TAD boundaries

```{r}

# Creating a GRanges object out of the tads

# For chromosome 22
coords <- c(chr22_domains[,2],chr22_domains[,3])
chr22_coords <- data.frame(chr="chr22", coordinates=coords)
chr22_coords <- chr22_coords[order(chr22_coords$coordinates),]
dim(chr22_coords)
#354   2
#remove duplicates for coordinates that are conjoined
chr22_coords <- chr22_coords[!duplicated(chr22_coords), ]
dim(chr22_coords)
#314  2

# flanking either side of the TAD boundary by 500 bases for a 1kb centerd boundary region
chr22_bounds <- GRanges(seqnames=chr22_coords$chr, ranges=IRanges(start=chr22_coords$coordinates, width=1))
chr22_bounds <- resize(chr22_bounds, 1001, fix = "center")
chr22_bounds

#Creating an indicator variable Y that denotes whether the tad boundary overlaps the genomic bin for chr 22

y <- countOverlaps(chr22_bins, chr22_bounds, type = "within")
length(y)
table(y)
prop.table(table(y))

#y <- countOverlaps(binslist, tad_bounds)
#length(y)
```

# Reading in genomic feature data (subcompartments)

```{r}
subcompart <- read.table("GSE63525_GM12878_subcompartments.BED",header = F)
subcompart <- subcompart[,1:4]
names(subcompart) <- c("chr", "x1", "x2", "compartment")
dim(subcompart)
subcompart <- subcompart[-which(is.na(subcompart$compartment)),]
head(subcompart)
table(subcompart$compartment)
subcompart$compartment <- as.character(subcompart$compartment)

#combining compartments
subcompart$compartment[grep("A",subcompart$compartment)] <- "A"
subcompart$compartment[grep("B",subcompart$compartment)] <- "B"
table(subcompart$compartment)

#Crearing indicator variables from levels of subcompartments
dummy <- dummyVars(~compartment,
                   data=subcompart,
                   fullRank=T)
subcompart2 <- data.frame(predict(dummy,newdata=subcompart))

subcompart3 <- cbind.data.frame(subcompart[,1:3],subcompart2)
head(subcompart3)

#for chromosome 22
chr22_subcomp <- subcompart3[which(subcompart3$chr=="chr22"),]
dim(chr22_subcomp)

Asubcomp <- chr22_subcomp[which(chr22_subcomp$compartmentB==0),]
Bsubcomp <- chr22_subcomp[which(chr22_subcomp$compartmentB==1),]

Asubcompint <- GRanges(seqnames = "chr22", ranges = IRanges(start=Asubcomp$x1,end=Asubcomp$x2))
Bsubcompint <- GRanges(seqnames = "chr22", ranges = IRanges(start=Bsubcomp$x1,end=Bsubcomp$x2))

#There are only 36 subcompartments associated with chromosome 22. With a mean width of 1366668 for subcompartment A and 614287 for subcompartment B. Therefore the intervals are much larger than the genomic bins of 50 bases

```

# Creating predictor vectors corresponding to if there is an overlap for compartment A

```{r}

X_A <- countOverlaps(chr22_bins, Asubcompint, type = "any")
table(X_A)
X_A2 <- countOverlaps(chr22_bins, Asubcompint, type = "within")
table(X_A2)
#there are 410015-410000=15 intervals for subcompartment A that
#have partial overlapping with genomic bins

#finding percentage of partial overlaps for compartment A
partialoverlaps <- setdiff(findOverlaps(chr22_bins, Asubcompint, type = "any"),findOverlaps(chr22_bins, Asubcompint, type = "within"))
hits <- pintersect(chr22_bins[queryHits(partialoverlaps)], Asubcompint[subjectHits(partialoverlaps)])
hits
#it appears all partial overlaps land on the very end coordinate of the
#genomic bins
#thus the percentage overlap would be 1/50=.02
percentOverlap <- width(hits) / width(chr22_bins[queryHits(partialoverlaps)])
percentOverlap

#changing the partial overlaps to percentages
X_A[queryHits(partialoverlaps)] <- .02
table(X_A)
```

#Creating predictor vectors corresponding to if there is an overlap for compartment B
```{r}

X_B <- countOverlaps(chr22_bins, Bsubcompint, type = "any")
table(X_B)
#some intervals for subcompartment B have multiple overlaps in one genomic bin

X_B2 <- countOverlaps(chr22_bins, Bsubcompint, type = "within")
table(X_B2)
#there are 258007+7*2-258000=21 intervals for subcompartment B 
#that have partial overlapping with genomic bins

#Finding the percentage of partial overlap for compartment B
partialoverlaps <- setdiff(findOverlaps(chr22_bins, Bsubcompint, type = "any"),
                           findOverlaps(chr22_bins, Bsubcompint, type = "within"))
hits <- pintersect(chr22_bins[queryHits(partialoverlaps)], 
                   Bsubcompint[subjectHits(partialoverlaps)])
hits
#it appears all partial overlaps land on the very end coordinate of the
#genomic bins
#thus the percentage overlap would be 1/50=.02
percentOverlap <- width(hits) / width(chr22_bins[queryHits(partialoverlaps)])
percentOverlap

#changing the partial overlaps to percentages
X_B[queryHits(partialoverlaps)] <- .02
table(X_B)
```

