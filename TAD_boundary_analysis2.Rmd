---
title: "TAD Boundary Analysis V2"
author: "Spiro Stilianoudakis"
date: "April 27, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries

```{r}
library(MultiAssayExperiment)
library(GenomicRanges)
library(IRanges)
library(caret)
library(data.table)
library(gbm)
library(pROC)
library(plyr)
library(dplyr)
```


# Reading in TAD data

```{r}

setwd("C:/Users/Spiro Stilianoudakis/Documents/TAD_data_analysis/data")

domains <- read.table("arrowhead_data.txt", header=T)
domains <- domains[,1:3]
head(domains)
dim(domains)
#9274   3

```

# Creating TAD boundaries

## The TAD boundary start and end coordinates were row binded into one long vector. The vector was sorted and each coordinate was flanked on each side by 500 bases for a 1kb TAD boundary bin.

```{r}

# Creating a GRanges object out of the tads

colnames(domains)[2:3] <- c("coordinate", "coordinate")
coords <- rbind.data.frame(domains[,c(1,2)],domains[,c(1,3)])

#Removing the X chromosome from the analysis
coords <- coords[-which(coords$Chromosome=="chrX"),]

#Sorting the numeric chromosome coordinates
coords <- coords[order(as.numeric(substr(coords$Chromosome,4,5)), coords$coordinate),]

#remove duplicates for coordinates that are conjoined
coords <- coords[!duplicated(coords),]
dim(coords)
#16770     2

# flanking either side of the TAD boundary by 500 bases for a 1kb centered boundary region
coords$Chromosome <- as.character(coords$Chromosome)
bounds <- GRanges(seqnames=coords$Chromosome, ranges=IRanges(start=coords$coordinate, width=1))
bounds <- resize(bounds, 1000, fix = "center")
bounds
prop.table(table(seqnames(bounds)))



```

# Reading in and cleaning genomic feature data (subcompartments)

```{r}

subcompart <- read.table("GSE63525_GM12878_subcompartments.BED",header = F)
subcompart <- subcompart[,1:4]
names(subcompart) <- c("chr", "x1", "x2", "compartment")
dim(subcompart)
subcompart <- subcompart[-which(is.na(subcompart$compartment)),]
head(subcompart)
table(subcompart$compartment)
subcompart$compartment <- as.character(subcompart$compartment)

#combining compartments
subcompart$compartment[grep("A",subcompart$compartment)] <- "A"
subcompart$compartment[grep("B",subcompart$compartment)] <- "B"
table(subcompart$compartment)
#   A    B 
#1739 2110
prop.table(table(subcompart$compartment))
#        A         B 
#0.4518057 0.5481943 

#ordering the subcompartment data
subcompart <- subcompart[order(substr(subcompart$chr,4,5),
                               subcompart$x1),]

#creating granges object out of subcompartment data
#coding strand according to A or B compartment (need to have this
#information in order for the reduce() command to work properly) 
#using the reduce function to collapse the consecutive intervals
#Note: A -> +; B -> -
subcompartgr <- GRanges(seqnames = subcompart$chr, 
                        ranges = IRanges(start=subcompart$x1, 
                                         end=subcompart$x2), 
                        strand = ifelse(subcompart$compartment=="A","+","-"))
subcompartgr <- reduce(subcompartgr)
#reduce command shrunk the subcompartment intervals from 3849 to 2909
#adding the type of subcompartment as metadata for granges object
mcols(subcompartgr)$compartment <- ifelse(strand(subcompartgr)=="+","A","B")

#subcompartdf <- data.frame(chr = seqnames(subcompartgr),
#                           start = start(subcompartgr),
#                           end = end(subcompartgr),
#                           comparment = mcols(subcompartgr)$compartment)
#write.table(subcompartdf, "subcompart_reduced.bed")


########################################################################
#concatenating enpoints and creating 5kb flanks
subcompdata <- data.frame(chr=seqnames(subcompartgr),
                          x1=start(subcompartgr),
                          x2=end(subcompartgr),
                          compartment=mcols(subcompartgr)$compartment)

colnames(subcompdata)[2:3] <- c("coordinate", "coordinate")
subcompdata2 <- rbind.data.frame(subcompdata[,c(1,2)],subcompdata[,c(1,3)])

#Sorting the numeric chromosome coordinates
subcompdata2 <- subcompdata2[order(as.numeric(substr(subcompdata2$chr,4,5)), subcompdata2$coordinate),]

#remove duplicates for coordinates that are conjoined
subcompdata2 <- subcompdata2[!duplicated(subcompdata2),]
dim(subcompdata2)
#3114    2

# flanking either side of the Subcompartment boundary by 5kb for a 10kb centerd boundary region
subcompdata2$chr <- as.character(subcompdata2$chr)
subcompdatagr <- GRanges(seqnames=subcompdata2$chr, ranges=IRanges(start=subcompdata2$coordinate, width=1))
subcompdatagr <- resize(subcompdatagr, 10000, fix = "center")
subcompdatagr
prop.table(table(seqnames(subcompdatagr)))

#origsubcomp_gr <- granges(seqnames=subcompart[,1],
#                          ranges=IRanges(start=))


```

# Finding where the 1kb flanked tad boundaries overlap the subcompartments and labeling the overlap as A or B

```{r}

#There are 3 scenarios of overlaps that can occur:
#i. partial
#ii. within
#iii. none
#For partial overlaps, they can either be between two (or more) subcompartments, or with only one subcompartment (i.e. there is a break between compartments)

#For Within:
within <- findOverlaps(bounds, subcompartgr, type="within")
#there are 16593 intervals from the tad boundaries that overlab strictly within flanked subcompartments
subcompoverlapwithin <- bounds[queryHits(within)]
#attaching the subcompartment info to the within overlaps
mcols(subcompoverlapwithin)$compartment <- mcols(subcompartgr)$compartment[subjectHits(within)]
#adding percent overlap for each A abd B compartments
mcols(subcompoverlapwithin)$percentA <- ifelse(mcols(subcompoverlapwithin)$compartment=="A",1,0)
mcols(subcompoverlapwithin)$percentB <- ifelse(mcols(subcompoverlapwithin)$compartment=="B",1,0)


#For none:
subcompoverlapnone <- bounds[which(bounds %outside% subcompartgr)]
#there are 19 intervals that have no overlaps
#attaching the subcompartment info in the form of "N" for no overlap
mcols(subcompoverlapnone)$compartment <- "N"
#adding percent overlap
mcols(subcompoverlapnone)$percentA <- 0
mcols(subcompoverlapnone)$percentB <- 0


#For partial: the difference among the sets of any type of overlap and within overlaps
subcompoverlapany <- findOverlaps(bounds, subcompartgr, type="any")
#there are 16904 overlaps from the tad boundaries with subcompartment intervals
#note: there are only 16770 tad boundaries though.
#that means that there are some places where a flanked tad boundary is a part of two (or more) subcompartment intervals
#For example:
bounds[158] #ovelaps the following two subcompartment intervals 
subcompartgr[c(12,150)]

subcomppartial <- setdiff(subcompoverlapany,within)

```
